# Workflow Diagrams

## Complete Sync Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AMAZON → PLYTIX SYNC WORKFLOW                         │
└─────────────────────────────────────────────────────────────────────────────┘

╔═══════════════════════════════════════════════════════════════════════════╗
║ PHASE 1: EXPORT                                                            ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                            ║
║  ┌────────────┐    ┌──────────────────┐    ┌─────────────────────┐        ║
║  │  Amazon    │───▶│ searchCatalogItems│───▶│  twistedx_export   │        ║
║  │  SP-API    │    │ getCatalogItem    │    │     .json          │        ║
║  └────────────┘    └──────────────────┘    └─────────────────────┘        ║
║                            │                          │                    ║
║                            ▼                          ▼                    ║
║                   ┌──────────────────┐    ┌─────────────────────┐         ║
║                   │ fetch_missing_   │    │ Products + Parents  │         ║
║                   │ parents()        │    │ + Images + Metadata │         ║
║                   └──────────────────┘    └─────────────────────┘         ║
║                                                                            ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    │
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║ PHASE 2: MAPPING                                                           ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                            ║
║  ┌─────────────────┐         ┌─────────────────┐                          ║
║  │ Amazon Export   │◄───────▶│ Plytix Products │                          ║
║  │ (ASINs)         │         │ (SKUs)          │                          ║
║  └─────────────────┘         └─────────────────┘                          ║
║           │                          │                                     ║
║           └──────────┬───────────────┘                                     ║
║                      ▼                                                     ║
║           ┌─────────────────────────┐                                      ║
║           │    MATCHING LOGIC       │                                      ║
║           │ ─────────────────────── │                                      ║
║           │ 1. GTIN → GTIN          │                                      ║
║           │ 2. EAN → EAN            │                                      ║
║           │ 3. UPC → UPC            │                                      ║
║           │ 4. model_number → SKU   │                                      ║
║           └─────────────────────────┘                                      ║
║                      │                                                     ║
║                      ▼                                                     ║
║           ┌─────────────────────────┐                                      ║
║           │   mca0032_mapping.json  │                                      ║
║           │ ─────────────────────── │                                      ║
║           │ matched: [{...}]        │                                      ║
║           │ unmatched_amazon: [...]│                                      ║
║           │ suggested_sku: AMZN-*   │                                      ║
║           └─────────────────────────┘                                      ║
║                                                                            ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    │
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║ PHASE 3: SYNC PRODUCTS                                                     ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                            ║
║  ┌─────────────────┐         ┌─────────────────────────────────┐          ║
║  │ mca0032_mapping │────────▶│         PLYTIX                  │          ║
║  │ .json           │         │  ┌─────────────────────────┐    │          ║
║  └─────────────────┘         │  │ AMZN-US-B07X8Z63ZL      │    │          ║
║                              │  │ ─────────────────────── │    │          ║
║  For each ASIN:              │  │ amazon_asin: B07X8Z63ZL │    │          ║
║  ┌──────────────────┐        │  │ amazon_title: "..."      │    │          ║
║  │ Check if exists  │        │  │ amazon_marketplace: US   │    │          ║
║  │       ▼          │        │  │ amazon_canonical_sku:    │    │          ║
║  │ Create product   │───────▶│  │   MCA0032-105W-BOMB     │    │          ║
║  │       ▼          │        │  └─────────────────────────┘    │          ║
║  │ Set attributes   │        │                                  │          ║
║  └──────────────────┘        └─────────────────────────────────┘          ║
║                                                                            ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    │
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║ PHASE 4: RELATIONSHIPS                                                     ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                            ║
║  ┌─────────────────────────────────────────────────────────────────┐      ║
║  │                    AMAZON HIERARCHY                              │      ║
║  │                    (Parent → Children)                           │      ║
║  │  ┌─────────────────────────────────────────────────────────┐    │      ║
║  │  │                                                         │    │      ║
║  │  │   AMZN-US-B077QMJFG9 (VARIATION_PARENT)                │    │      ║
║  │  │           │                                             │    │      ║
║  │  │           ├───▶ AMZN-US-B07TBFZL3N                     │    │      ║
║  │  │           └───▶ AMZN-US-B07X8Z63ZL                     │    │      ║
║  │  │                                                         │    │      ║
║  │  └─────────────────────────────────────────────────────────┘    │      ║
║  └─────────────────────────────────────────────────────────────────┘      ║
║                                                                            ║
║  ┌─────────────────────────────────────────────────────────────────┐      ║
║  │                    AMAZON LISTINGS                               │      ║
║  │                    (Canonical → Amazon)                          │      ║
║  │  ┌─────────────────────────────────────────────────────────┐    │      ║
║  │  │                                                         │    │      ║
║  │  │   MCA0032 (Canonical Plytix)                           │    │      ║
║  │  │           │                                             │    │      ║
║  │  │           ├───▶ AMZN-US-B09FQ13BDF                     │    │      ║
║  │  │           ├───▶ AMZN-US-B0C89T5YRQ                     │    │      ║
║  │  │           └───▶ AMZN-US-B077QMJFG9                     │    │      ║
║  │  │                                                         │    │      ║
║  │  └─────────────────────────────────────────────────────────┘    │      ║
║  └─────────────────────────────────────────────────────────────────┘      ║
║                                                                            ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    │
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║ PHASE 5: IMAGES                                                            ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                            ║
║  ┌──────────────┐    ┌──────────────┐    ┌─────────────────────────┐      ║
║  │ Amazon CDN   │───▶│ Upload Asset │───▶│ Link to Product         │      ║
║  │ Image URLs   │    │ (Dedupe)     │    │ (amazon_images gallery) │      ║
║  └──────────────┘    └──────────────┘    └─────────────────────────┘      ║
║                             │                        │                     ║
║                             ▼                        ▼                     ║
║                    ┌──────────────┐        ┌─────────────────┐            ║
║                    │ Handle 409   │        │ Set Thumbnail   │            ║
║                    │ (existing)   │        │ (MAIN image)    │            ║
║                    └──────────────┘        └─────────────────┘            ║
║                                                                            ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

## Data Model Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PLYTIX PRODUCT HIERARCHY                           │
└─────────────────────────────────────────────────────────────────────────────┘

                        CANONICAL PRODUCTS
                        ══════════════════

    ┌─────────────────────────────────────────────────────────────────┐
    │                                                                 │
    │   ┌─────────────┐         ┌─────────────┐                      │
    │   │   MCA0032   │         │   MDM0049   │                      │
    │   │  (parent)   │         │  (parent)   │                      │
    │   └──────┬──────┘         └──────┬──────┘                      │
    │          │                       │                              │
    └──────────┼───────────────────────┼──────────────────────────────┘
               │                       │
               │ Amazon Listings       │ Amazon Listings
               │                       │
    ┌──────────┼───────────────────────┼──────────────────────────────┐
    │          │                       │                              │
    │          ▼                       ▼                              │
    │   ┌─────────────┐         ┌─────────────┐                      │
    │   │ AMZN-US-    │         │ AMZN-US-    │                      │
    │   │ B09FQ13BDF  │         │ B077QMJFG9  │◄────────────────┐    │
    │   │ (V_PARENT)  │         │ (V_PARENT)  │                 │    │
    │   │ model:      │         │ model:      │                 │    │
    │   │  MCA0032    │         │  MDM0049    │                 │    │
    │   └─────────────┘         └──────┬──────┘                 │    │
    │                                  │                        │    │
    │                                  │ Amazon                 │    │
    │                                  │ Hierarchy              │    │
    │                                  │                        │    │
    │                                  ▼                        │    │
    │                           ┌─────────────┐                 │    │
    │                           │ AMZN-US-    │                 │    │
    │                           │ B07TBFZL3N  │─────────────────┘    │
    │                           │ (child)     │  parent_asin         │
    │                           │ parent_asin:│  = B077QMJFG9        │
    │                           │ B077QMJFG9  │                      │
    │                           └─────────────┘                      │
    │                                                                │
    │                        AMAZON PRODUCTS                         │
    │                        ═══════════════                         │
    └────────────────────────────────────────────────────────────────┘
```

## VARIATION_PARENT Linking

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LINKING VARIATION_PARENT TO CANONICAL                     │
└─────────────────────────────────────────────────────────────────────────────┘

    Amazon Export Data                    Plytix Products
    ══════════════════                    ═══════════════

    ┌────────────────────────┐           ┌────────────────────────┐
    │ B09FQ13BDF             │           │ MCA0032                │
    │ ────────────────────── │           │ ────────────────────── │
    │ item_classification:   │           │ (Canonical Parent)     │
    │   VARIATION_PARENT     │           │                        │
    │ model_number: MCA0032  │──────────▶│                        │
    │                        │  Link via │                        │
    │                        │  model_   │                        │
    │                        │  number   │                        │
    └────────────────────────┘           └────────────────────────┘

                    │                              │
                    │                              │
                    ▼                              ▼

    ┌────────────────────────┐           ┌────────────────────────┐
    │ AMZN-US-B09FQ13BDF     │◀─────────│ MCA0032                │
    │ ────────────────────── │  Amazon   │ ────────────────────── │
    │ amazon_asin: B09FQ13BDF│  Listings │ Related Products:      │
    │ amazon_canonical_sku:  │  relation │   AMZN-US-B09FQ13BDF  │
    │   MCA0032              │           │   AMZN-US-B0C89T5YRQ  │
    └────────────────────────┘           └────────────────────────┘
```

## Image Sync Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            IMAGE SYNC FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐
    │ Amazon CDN URL  │
    │ https://m.media │
    │ -amazon.com/... │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐      ┌─────────────────┐
    │ Check Dedupe    │─────▶│ URL in cache?   │
    │ Cache           │      └────────┬────────┘
    └─────────────────┘               │
                              ┌───────┴───────┐
                              │               │
                         YES  ▼          NO   ▼
                    ┌─────────────┐    ┌─────────────┐
                    │ Use cached  │    │ Upload to   │
                    │ asset_id    │    │ Plytix      │
                    └──────┬──────┘    └──────┬──────┘
                           │                  │
                           │           ┌──────┴──────┐
                           │           │             │
                           │      409  ▼        200  ▼
                           │   ┌───────────┐  ┌───────────┐
                           │   │ Extract   │  │ New asset │
                           │   │ existing  │  │ created   │
                           │   │ asset_id  │  │           │
                           │   └─────┬─────┘  └─────┬─────┘
                           │         │              │
                           └─────────┼──────────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ Link to product │
                            │ (amazon_images) │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ MAIN variant?   │
                            └────────┬────────┘
                                     │
                              ┌──────┴──────┐
                         YES  ▼        NO   ▼
                    ┌─────────────┐   ┌─────────────┐
                    │ Set as      │   │ Done        │
                    │ thumbnail   │   │             │
                    └─────────────┘   └─────────────┘
```

## Script Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          SCRIPT EXECUTION ORDER                              │
└─────────────────────────────────────────────────────────────────────────────┘

   ┌───────────────────────────────────────────────────────────────────────┐
   │                                                                       │
   │  1. export_amazon_catalog.py                                         │
   │     ├── Input: --brand "Twisted X" --include-parents                 │
   │     └── Output: data/twistedx_export.json                            │
   │                                                                       │
   │                              │                                        │
   │                              ▼                                        │
   │                                                                       │
   │  2. generate_asin_mapping.py                                         │
   │     ├── Input: --export twistedx_export.json --style MCA0032         │
   │     └── Output: data/mca0032_mapping.json                            │
   │                                                                       │
   │                              │                                        │
   │                              ▼                                        │
   │                                                                       │
   │  3. sync_amazon_products.py                                          │
   │     ├── Input: --mapping mca0032_mapping.json --execute              │
   │     └── Output: data/mca0032_mapping.sync_products.json              │
   │                                                                       │
   │                              │                                        │
   │                              ▼                                        │
   │                                                                       │
   │  4. (Manual/API) Link Relationships                                  │
   │     ├── Amazon Hierarchy: Parent → Children                          │
   │     └── Amazon Listings: Canonical → Amazon                          │
   │                                                                       │
   │                              │                                        │
   │                              ▼                                        │
   │                                                                       │
   │  5. sync_amazon_images.py                                            │
   │     ├── Input: --mapping mca0032_mapping.json --execute              │
   │     └── Output: data/mca0032_mapping_image_sync.json                 │
   │                                                                       │
   └───────────────────────────────────────────────────────────────────────┘
```
