# PRI Direct Container Process - Complete Automation Analysis

## Overview

Analysis of the direct container fulfillment automation: when a customer orders a direct container fulfilled factory-to-customer, the Sales Order should automatically **pick** (create Item Fulfillment) and **invoice** (create Invoice) once all goods are received.

**Two bundles work together:**
- **PRI Container Tracking** (Bundle 125246) → Auto-Pick (Item Fulfillment creation)
- **PRI Business Process Automation** (Bundle 311735) → Auto-Invoice (Invoice creation from shipped IF)

---

## Complete Direct Container Flow

### Pre-Automation Setup (Manual Steps)

1. **Direct Container Sales Order** entered for the customer
2. **Purchase Order(s)** created with `custbody_pri_fgt_cntr_direct_imp_so` linking to the SO
3. **Container record** (`customrecord_pri_frgt_cnt`) created, linked to a **Transfer Order**
4. Container ships from factory → goes through vessel/transit tracking
5. Container arrives at destination → **Transfer Order Item Receipt** is created

### Automation Trigger

When a **Transfer Order Item Receipt** is created or edited, the UserEvent script fires:

**File**: `SuiteBundles/Bundle 125246/PRI Container Tracking/pri_itemrcpt_ss.js:291`
```
afterSubmit → TRANLIB.pri_itemrcpt_to_directImport(scriptContext)
```

---

## Step-by-Step Automation Flow

### Step 1: Queue Entry Creation (PRI Container Tracking)
**File**: `SuiteBundles/Bundle 125246/PRI Container Tracking/pri_itemrcpt_lib.js:2120-2233`
**Function**: `pri_itemrcpt_to_directImport(scriptContext)`

1. Gets the Item Receipt's `createdfrom` (Transfer Order)
2. Iterates IR lines to collect related PO IDs from `custcol_pri_frgt_cnt_related_tran`
3. Checks for loop prevention: if all IR lines already have `custcol_pri_fgt_cntr_direct_imp_if` (IF writeback), exits
4. Checks for duplicate queue entries (prevents re-queuing for same IR)
5. Queries POs to find linked Sales Orders via `custbody_pri_fgt_cntr_direct_imp_so`
6. For each unique SO, creates a `PRI_DIRECT_IMPORT_ORDER` queue entry with staggered delay
   - Delay managed via App Setting: `'Delay Minute for PRI_DIRECT_IMPORT_ORDER Queues belong to Same SO'`
   - Prevents concurrent save conflicts on the same large SO
7. Queue entry params: `{ type: "itemreceipt", id: <IR_ID>, salesorder: <SO_ID> }`

### Step 2: Scheduled Script Processes Queue — Auto-Pick / Fulfillment (PRI Container Tracking)
**File**: `SuiteBundles/Bundle 125246/PRI Container Tracking/pri_SC_directImport_fulfillOrd.js`
**Script ID**: `customscript_pri_fgt_cntr_direct_imp_ful`
**Deployments**: 3 deployments (15-min and 30-min intervals, plus on-demand)
**Queue Name**: `PRI_DIRECT_IMPORT_ORDER`

For each queue entry:

#### 2a. Load Records
- Loads the Sales Order (`intSOId`)
- Loads the Transfer Order Item Receipt (`objOrderId.id`)

#### 2b. Status Check (Lines 194-202)
- If SO status is already `'Billed'` or `'Pending Billing'`, tries to find an existing matching IF
- Uses `findExistingSOItemFulfillment()` which matches by BPA Line Key + quantity sums
- If found, returns existing IF ID (idempotent)

#### 2c. Commitment Update (Lines 206-251)
- Iterates IR lines, matches to SO lines via `custcol_pri_bpa_so_line` (BPA Line Key)
- Sets `commitinventory = 1` ("Available Qty") on matching SO lines
- Saves SO to commit inventory

#### 2d. Commitment Validation (Lines 254-322)
- Re-validates that committed qty >= IR qty for every IR line
- If any line fails: abandons queue entry with "Items are not committed to the Sales Order"
- Queue entry will be retried on next scheduled run

#### 2e. Create Item Fulfillment (Lines 325-402)
```javascript
record.transform({
    fromType: record.Type.SALES_ORDER,
    fromId: intSOId,
    toType: record.Type.ITEM_FULFILLMENT
});
```
- Sets `shipstatus = 'C'` (Shipped)
- Sets `trandate` to IR's trandate
- Sets `memo` = "Auto Generated by Freight Container Direct Import Module"
- Sets `custbody_pri_fgt_cntr_direct_imp_irln` = IR ID
- Iterates IF lines: only marks `itemreceive = true` for lines matching IR BPA Line Keys
- Sets quantities from IR line quantities (aggregated by BPA Line Key via `getTOIRobjLnKeyQty()`)

#### 2f. Writeback to Item Receipt (Lines 88-119)
- Loads the IR record
- Sets `custcol_pri_fgt_cntr_direct_imp_if` = new IF ID on all IR lines
- This writeback prevents re-queuing (loop prevention in Step 1)

#### 2g. Partial Fulfillment Handling (Lines 406-464)
- After IF creation, checks if SO lines are fully fulfilled
- If `quantityfulfilled < quantity`: sets `commitinventory = 3` ("Do Not Commit")
- Prevents leftover unfulfilled quantities from tying up inventory

#### 2h. Queue Completion
- Marks queue entry complete with "Created/Linked SO Item Fulfillment ID: #XXX"

---

### Step 3: Auto-Invoice (PRI BPA Bundle — Bundle 311735)

When the Item Fulfillment is saved with `shipstatus = 'C'` (Shipped) in Step 2e, **NetSuite fires a UserEvent on the Item Fulfillment record**. The BPA bundle has a UE deployed to Item Fulfillment that handles auto-invoicing.

#### 3a. BPA UserEvent Trigger
**Script Definition**: `Objects/usereventscript/customscript_pri_bpa_ue_item_fulfillment.xml`
**Script File**: `/SuiteBundles/Bundle 311735/BPA General/bpa-auto-invoicing/PRI_BPA_UE_ItemFulfillment.js`
**Record Type**: ITEMFULFILLMENT
**Execution Context**: ALL (including SCHEDULED, SUITELET — so it fires even when the IF is created by the scheduled script)

**Description from XML**: *"If App Setting is configured, auto-invoices the individual item fulfillment, and sets a link from the fulfillment to the invoice; optionally, attempts to pay the invoice using floating customer deposits."*

> **Note**: The `PRI_BPA_UE_ItemFulfillment.js` source file is NOT in the local codebase (it lives only in the NetSuite bundle environment at `/SuiteBundles/Bundle 311735/BPA General/bpa-auto-invoicing/`). The behavior is inferred from the XML deployment definition and the library/suitelet code.

The UE fires `afterSubmit` on the Item Fulfillment. It:
1. Checks the App Setting **"Auto-Create Invoice From Fulfillment"** (Boolean) — must be `T`
2. Optionally checks **"Auto-Create Invoice From Fulfillment Field"** — if set, the IF must have a truthy value in that custom field
3. Calls the BPA Suitelet (`customscript_pri_bpa_sl_utilities` / `customdeploy_pri_bpa_sl_utilities`) via HTTP with `action=createinvoice&ffId=<IF_ID>`

#### 3b. BPA Suitelet Entry Point
**File**: `SuiteBundles/Bundle 311735/BPA General/PRI_BPA_SL_Utilities.js`
**Script ID**: `customscript_pri_bpa_sl_utilities`

Receives the HTTP call with `action=createinvoice` and `ffId` parameter:
```javascript
case "createinvoice":
    var ffId = context.request.parameters.ffId;
    var invoiceId = bpaCommon.createInvoiceFromFulfillment(ffId);
```

#### 3c. Invoice Creation Logic
**File**: `SuiteBundles/Bundle 311735/BPA General/PRI_BPA_Common.js:157-367`
**Function**: `createInvoiceFromFulfillment(ffId)`

1. **Load Item Fulfillment**: `record.load({type: ITEM_FULFILLMENT, id: ffId})`
2. **Validate prerequisites**:
   - IF must be created from a Sales Order (not Transfer Order, etc.)
   - IF must be in Shipped status (`shipstatus == 'C'`)
   - IF must NOT already be linked to an invoice (`custbody_pri_bpa_ff_inv_link` is empty)
3. **Transform SO → Invoice**:
   ```javascript
   INV = record.transform({
       fromType: record.Type.SALES_ORDER,
       fromId: FF.getValue('createdfrom'),
       toType: record.Type.INVOICE
   });
   ```
   - Falls back to `record.Type.CASH_SALE` if Invoice transform fails (customer may require Cash Sale)
4. **Set Invoice fields**:
   - `trandate` = IF's trandate
   - `custbody_pri_bpa_ff_inv_link` = ffId (link back to fulfillment)
   - Handles shipping cost transfer from IF
5. **Match fulfilled lines**:
   - Iterates Invoice lines, matches to IF lines via `orderline`
   - For non-matching lines (not fulfilled in this IF): zeros out quantity or removes
   - Handles groups, subtotals, and discount items
   - Supports App Settings: "Invoice Non-Fulfillable Items", "Prorate Invoice Amount Based on Quantity"
6. **Save Invoice**: `INV.save({ignoreMandatoryFields: true})`
7. **Writeback**: Sets `custbody_pri_bpa_ff_inv_link` on the Item Fulfillment to link to the created Invoice

#### 3d. Optional Auto-Pay (Back in Suitelet)
After invoice creation, the Suitelet checks:
```javascript
var autoPayInvoice = appSettings.readAppSetting(bpaCommon.APP_NAME, "Auto-Pay Invoice");
if (autoPayInvoice && recordtype == INVOICE) {
    if (INV.getValue("amountremaining"))
        bpaCommon.payInvoiceWithDeposits(INV.id);
}
```
- If **"Auto-Pay Invoice"** App Setting is enabled, attempts to apply floating customer deposits to pay off the invoice

---

## App Settings (Configuration)

**Application**: `Prolecto Business Process Automation` (Bundle 311735)

| Setting Name | Type | Default | Purpose |
|-------------|------|---------|---------|
| Auto-Create Invoice From Fulfillment | Boolean | F | Master switch: enable auto-invoicing from shipped IFs |
| Auto-Create Invoice From Fulfillment Field | Text | (empty) | Optional: custom field that must be truthy for auto-invoice |
| Auto-Pay Invoice | Boolean | F | Pay invoice from floating customer deposits |
| Invoice Non-Fulfillable Items | Boolean | F | Include non-fulfillable items on invoice |
| Prorate Invoice Amount Based on Quantity | Boolean | F | Calculate amount as (SO amount * qtyFulfilled/qtyOrdered) |

**Application**: `PRI Container Tracking` (Bundle 125246)

| Setting Name | Purpose |
|-------------|---------|
| Delay Minute for PRI_DIRECT_IMPORT_ORDER Queues belong to Same SO | Stagger delay between queue entries for same SO |

---

## Key Custom Fields

| Field ID | Record | Purpose |
|----------|--------|---------|
| `custbody_pri_fgt_cntr_direct_imp_so` | PO body | Links PO to Direct Import Sales Order |
| `custcol_pri_bpa_so_line` | Transaction column | BPA Line Unique Key (matches IR lines to SO lines) |
| `custcol_pri_frgt_cnt_related_tran` | IR column | Related PO ID on Item Receipt lines |
| `custcol_pri_fgt_cntr_direct_imp_if` | IR column | Writeback: IF ID created by automation |
| `custcol_pri_fgt_cntr_direct_imp_po_id` | SO column | Direct Import PO ID on SO lines |
| `custbody_pri_fgt_cntr_direct_imp_irln` | IF body | Source Item Receipt ID |
| `custbody_pri_bpa_ff_inv_link` | IF/Invoice body | Links IF ↔ Invoice (bidirectional) |
| `custrecord_pri_frgt_cnt_direct_imp_loc` | Container | Direct Import Location |
| `custrecord_pri_frgt_cnt_direct_imp_ful` | Container | Direct Import Fulfillment flag |

## Key Scripts & Files

| File | Type | Role |
|------|------|------|
| `pri_itemrcpt_ss.js` | UserEvent (Item Receipt) | Trigger: calls `pri_itemrcpt_to_directImport` on afterSubmit |
| `pri_itemrcpt_lib.js` | Library | Queue entry creation logic (`pri_itemrcpt_to_directImport`) |
| `pri_SC_directImport_fulfillOrd.js` | ScheduledScript | Core automation: processes queue, commits inventory, creates IF |
| `PRI_BPA_UE_ItemFulfillment.js` | UserEvent (Item Fulfillment) | Auto-invoice trigger (NOT in local codebase) |
| `PRI_BPA_SL_Utilities.js` | Suitelet | Entry point: receives createinvoice action, calls Common |
| `PRI_BPA_Common.js` | Library | `createInvoiceFromFulfillment()` and `payInvoiceWithDeposits()` |
| `PRI_BPA_BI_Configure.js` | BundleInstallation | Creates App Settings for BPA |
| `pri_idRecord_cslib.js` | Library | Central ID registry for custom records/fields |
| `/.bundle/132118/PRI_QM_Engine` | Queue Manager | Prolecto queue system |
| `/.bundle/132118/PRI_AS_Engine` | App Settings | Configuration reader |

---

## Complete Automation Architecture Diagram

```
[Transfer Order Item Receipt Created/Edited]
         │
         ▼
[pri_itemrcpt_ss.js - afterSubmit]
         │
         ▼
[pri_itemrcpt_lib.js - pri_itemrcpt_to_directImport()]
    │ Collects PO IDs from IR lines
    │ Queries POs for linked SO IDs
    │ Creates PRI_DIRECT_IMPORT_ORDER queue entries
         │
         ▼
[PRI Queue Manager - customrecord_pri_qm_queue]
    │ Staggered delay per SO (configurable minutes)
         │
         ▼
[pri_SC_directImport_fulfillOrd.js - execute()]  (runs every 15-30 min)
    │
    ├─[1] Load SO + IR
    ├─[2] Status check (Billed/Pending Billing → find existing IF)
    ├─[3] Set commitinventory = 1 on SO lines matching IR BPA keys
    ├─[4] Validate committed qty >= IR qty (all lines)
    │      └─ FAIL → abandon queue entry → retry next run
    ├─[5] record.transform SO → Item Fulfillment
    │      ├─ shipstatus = 'C' (Shipped)
    │      ├─ Only receive lines matching IR BPA keys
    │      └─ Set quantities from IR
    ├─[6] Writeback IF ID to IR lines (loop prevention)
    ├─[7] Partial: set uncommitted lines to "Do Not Commit"
    └─[8] Mark queue complete
         │
         ▼  (IF record save triggers BPA UserEvent)
         │
[PRI_BPA_UE_ItemFulfillment.js - afterSubmit]  (Bundle 311735)
    │ Checks App Setting: "Auto-Create Invoice From Fulfillment"
    │ Optionally checks conditional field setting
    │ Calls BPA Suitelet via HTTP
         │
         ▼
[PRI_BPA_SL_Utilities.js - action=createinvoice]
    │
    ▼
[PRI_BPA_Common.js - createInvoiceFromFulfillment(ffId)]
    │
    ├─[1] Load Item Fulfillment
    ├─[2] Validate: from SO, shipped, not already invoiced
    ├─[3] record.transform SO → Invoice (or Cash Sale fallback)
    ├─[4] Set trandate from IF, handle shipping cost
    ├─[5] Match invoice lines to fulfilled lines via orderline
    ├─[6] Zero/remove unfulfilled lines
    ├─[7] Save Invoice
    ├─[8] Writeback: set custbody_pri_bpa_ff_inv_link on IF ↔ Invoice
    └─[9] Optional: payInvoiceWithDeposits() if App Setting enabled
         │
         ▼
[SO status → "Billed" / Invoice Created]
```

---

## Failure Modes & Retry Logic

| Scenario | Behavior |
|----------|----------|
| SO lines not committed | Queue entry abandoned → retried next scheduled run |
| IR already has IF writeback | `pri_itemrcpt_to_directImport` exits early (loop prevention) |
| Duplicate queue entry | Checked before creation (PTM13757 fix) |
| SO already Billed/Pending Billing | Finds existing IF by BPA Key + qty match |
| Another deployment running | Script exits (`anotherDeploymentIsExecuting()` check) |
| Governance limit reached | Script reschedules itself |
| Record doesn't exist | Queue entry abandoned with error |
| IF already has invoice link | `createInvoiceFromFulfillment` returns early (prevents double invoice) |
| Invoice transform fails | Falls back to Cash Sale transform |
| "Auto-Create Invoice" App Setting = F | BPA UE does nothing (auto-invoice disabled) |

---

## Troubleshooting Guide

### Direct Import Not Creating Item Fulfillment

**Symptoms**: Transfer Order Item Receipt created, but no Item Fulfillment appears on Sales Order

**Diagnostic Steps**:
1. Check queue for `PRI_DIRECT_IMPORT_ORDER` entries:
   ```sql
   SELECT * FROM customrecord_pri_qm_queue
   WHERE custrecord_pri_qm_queuename = 'PRI_DIRECT_IMPORT_ORDER'
   ORDER BY created DESC
   ```
2. Verify IR lines have `custcol_pri_frgt_cnt_related_tran` (PO link)
3. Verify PO has `custbody_pri_fgt_cntr_direct_imp_so` (SO link)
4. Check for commitment failures in queue entry notes

**Common Fixes**:
- If queue stuck: Use `reset_stuck_queue.js` for `PRI_DIRECT_IMPORT_ORDER`
- If no queue entry: Verify PO→SO linkage and IR→PO line relationships
- If commitment fails: Check SO line availability, may need manual commitment

### Direct Import Not Creating Invoice

**Symptoms**: Item Fulfillment created with `shipstatus = 'C'`, but no Invoice created

**Diagnostic Steps**:
1. Verify App Setting "Auto-Create Invoice From Fulfillment" = `T`
2. Check if conditional field setting exists and IF has truthy value
3. Verify IF is created from Sales Order (not Transfer Order)
4. Check `custbody_pri_bpa_ff_inv_link` - if populated, invoice already exists

**Common Fixes**:
- Enable App Setting in Prolecto Business Process Automation
- If conditional field configured, ensure field is checked on IF or remove setting
- If double-invoice concern, check existing invoice link before manual creation

### Queue Entry Abandoned Repeatedly

**Symptoms**: Queue entry shows "Items are not committed to the Sales Order" repeatedly

**Root Cause**: SO lines don't have sufficient committed inventory

**Fix**:
1. Manually commit inventory on SO lines matching IR BPA keys
2. Check for inventory availability at fulfillment location
3. Verify `custcol_pri_bpa_so_line` values match between IR and SO

---

## Key Observations

1. **Two-bundle architecture**: The auto-pick and auto-invoice are in separate Prolecto bundles that cooperate but are independently configurable
2. **Suitelet indirection**: The BPA auto-invoice uses a Suitelet call rather than directly creating the invoice in the UE — this provides a separate execution context with its own governance limits
3. **BPA UE source not local**: The `PRI_BPA_UE_ItemFulfillment.js` file is in the NetSuite bundle environment but NOT synced to this git repo. Only the XML deployment definition is tracked in `Objects/`
4. **Idempotent design**: Both the fulfillment (checks for existing IF) and invoice (checks `custbody_pri_bpa_ff_inv_link`) processes are designed to avoid duplicates
5. **Queue-based async**: The fulfillment creation is async via queue (15-30 min cycles), but the invoice creation is synchronous (fires immediately when IF is saved via the BPA UE afterSubmit)

---

**Document Version**: 1.0
**Last Updated**: 2026-01-29
**Analysis Confidence**: 95%+ (based on systematic code analysis)
